<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="static/interface.css" />
  <link rel="stylesheet" type="text/css" href="static/user-form.css" />

  <title>Strat Maker</title>
</head>

<body class="dark-mode">
  <nav class="navbar navbar-expand-lg navbar-dark-mode">
    <div class="navbar-container">
      <a class="navbar-brand" href="#">Strat Maker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav navbar-nav-left">
          <li class="nav-item">
            <a class="nav-link" href="/" data-bs-toggle="tooltip" title="Sign-up">
              <i class="fa fa-user-plus"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/login" data-bs-toggle="tooltip" title="Logout">
              <i class="fa fa-sign-out"></i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dbshow/{{username}}" data-bs-toggle="tooltip" title="History">
              <i class="fa fa-history"></i>
            </a>
          </li>
        </ul>
        <div class="navbar-actions">
          <button class="mode-toggle-btn" id="modeToggle">ðŸŒ™</button>
        </div>
      </div>
    </div>
  </nav>



    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}

            <p class="alert alert-success d-flex justify-content-between align-items-center" role="alert" style="margin:10px;">
              <span>
                <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                {{ message }}
              </span>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </p>

        {% endfor %}
      {% endif %}
    {% endwith %}


  <div class="container">
    <form action="/{{username}}" method="POST" class="box">
      <div class="mb-3">
        <label for="prompt_data" class="form-label" style="display:flex; justify-content:center;">
          <h5>User</h5>
        </label>
        <div style="position: relative;">
          <textarea name="prompt_data" placeholder="Enter your trading strategy here... (e.g., buy when rsi<30 and ema<vwap)" id="prompt_data" required></textarea>
          <button type="button" onclick="toggleSpeechRecognition()" class="mic-button">
            <i class="fa fa-microphone" aria-hidden="true"></i>
          </button>
        </div>
        <input type="hidden" name="history" value="{{ history }}">
      </div>

      <div style="display: flex; justify-content: space-between; margin-top: 1rem; gap: 1rem;">
        <button type="reset" class="button">Clear</button>
        <button type="submit" class="button">Submit</button>
      </div>
    </form>


{% if result %}
      <div class="box result-box" id="resultBox">
        <button class="close-button" onclick="closeResultBox()">Ã—</button>
        <label class="form-label" style="display: flex; justify-content: center;">
          <h5>Assistant</h5>
        </label>
<!--        <div class="result" id="result">-->
<!--            {{result}}-->
<!--        {{result | replace('\n', '<br>')}}-->
<!--            <div id="rule-builder"></div>-->
<!--            <div id="buying-sqroff-rules"></div>-->
<!--            <div id="selling-rules"></div>-->
<!--            <div id="selling-sqroff-rules"></div>-->
<!--            <button onclick="addRuleGroup()">Add Group</button>-->
<!--            <button onclick="getRules()">Get rules</button>-->
        <div class="result">
        <div class="user-form">
        <div id="rule-builder"></div>
        <div id="buying-sqroff-rules"></div>
        <div id="selling-rules"></div>
        <div id="selling-sqroff-rules"></div>
        </div>
        </div>

        <button class="uf-btn" onclick="getRules()" style="margin: 1.5rem auto; display: block;">Get Rules JSON</button>
<!--            <button class="uf-btn" onclick="addRuleGroup()" style="height:30px;">Add Group</button>-->
        <!--            <button class="uf-btn" onclick="testwindow()">TestWindow</button>-->
<!--            {{result | replace('\n', '<br>') | safe}}-->
<!--            </div>-->

        <hr class="hr-border">
        <div>
          <span class="copy-button">
            <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.15.1/cdn/shoelace.js"></script>
            <sl-copy-button value="{{result}}"></sl-copy-button>
          </span>
        </div>
      </div>
    {% endif %}

  </div>



<!--      <button class="code-container" onclick="showZoomedContent()">-->
<!--        <i class="fa-solid fa-code"></i>-->
<!--        <div class="json-format-code">-->
<!--          {{result | replace('\n', '<br>') | safe}}-->
<!--        </div>-->
<!--      </button>-->


  <div class="box2 result-box2">
    <div class="history-header">
      <h5 class="history-title">
        <a href="/dbshow/{{username}}" class="history-link">Chat History</a>
      </h5>
    </div>
    <div class="history">
      {% for item in chat_history|reverse %}
        <div class="chat-entry">
          <div class="message-box">
            <div class="user-message">
              <div class="message-meta">
                <strong class="username">{{username}}</strong>
                <span class="timestamp">{{item.timestamp.strftime("%d-%m-%Y %H:%M:%S")}}</span>
              </div>
              <div class="prompt">{{item.prompt}}</div>
            </div>
            <div class="assistant-message">
              <div class="message-meta">
                <strong class="assistant">Assistant</strong>
                <button class="zoom-btn" aria-label="Expand response">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/>
                    <path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/>
                    <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5"/>
                  </svg>
                </button>
              </div>
              <div class="response response-collapsed">{{item.responses}}</div>
            </div>
          </div>
          <div class="zoomed-container">
            <div class="zoomed-content">
              <button class="close-btn" aria-label="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11M13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0"/>
                  <path d="M10.344 11.742q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1 6.5 6.5 0 0 1-1.398 1.4z"/>
                  <path fill-rule="evenodd" d="M3 6.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5"/>
                </svg>
              </button>
              <div class="zoomed-body">
                <div class="zoomed-heading">{{username}}</div>
                <div class="zoomed-prompt">{{item.prompt}}</div>
                <div class="zoomed-heading">Assistant</div>
                <pre class="zoomed-response"><code>{{item.responses}}</code></pre>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="static/interface.js"></script>
  <link rel="stylesheet" type="text/css" href="static/user-form.css" />

  <!--  <script src="static/interfaceTesting.js"></script>-->

  <script>

  const result = {{result|tojson|safe}};
  let initialJson;
  try {
    // Handle both string and object results
    if (typeof result === 'string') {
      initialJson = JSON.parse(result);
    } else {
      initialJson = result;
    }
    // Ensure Config structure exists
    if (!initialJson.Config) {
      console.error('Invalid JSON structure - missing Config');
      initialJson = {
        Config: {
          BuyCondition: { conditionOperator: 'AND', conditions: [] },
          SellCondition: { conditionOperator: 'AND', conditions: [] },
          Buy_squareoff_condition: { conditionOperator: 'AND', conditions: [] },
          Sell_squareoff_condition: { conditionOperator: 'AND', conditions: [] }
        }
      };
    }
  } catch (e) {
    console.error('Error parsing JSON:', e);
    console.error('Result:', result);
    initialJson = {
      Config: {
        BuyCondition: { conditionOperator: 'AND', conditions: [] },
        SellCondition: { conditionOperator: 'AND', conditions: [] },
        Buy_squareoff_condition: { conditionOperator: 'AND', conditions: [] },
        Sell_squareoff_condition: { conditionOperator: 'AND', conditions: [] }
      }
    };
  }

  const ruleBuilder = document.getElementById('rule-builder');
  const SellConditionContainer = document.getElementById('selling-rules');
  const Buy_squareoff_conditionContainer = document.getElementById('buying-sqroff-rules');
  const Sell_squareoff_conditionContainer = document.getElementById('selling-sqroff-rules');

  function createRuleGroup(json, conditions) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'rule-group';

      const conditionSelect = document.createElement('select');
      conditionSelect.innerHTML = `
          <option value="AND">AND</option>
          <option value="OR">OR</option>
      `;
      conditionSelect.value = json.conditionOperator || 'AND';
      groupDiv.appendChild(conditionSelect);

      (Array.isArray(json.conditions) ? json.conditions : [json.conditions]).forEach(rule => {
          if (rule.conditions) {
              const subgroup = createRuleGroup(rule, conditions);
              groupDiv.appendChild(subgroup);
          } else if (rule) {
              const ruleDiv = createRule(rule, conditions);
              groupDiv.appendChild(ruleDiv);
          }
      });

      const addRuleBtn = document.createElement('button');
      addRuleBtn.innerText = 'Add rule';
      addRuleBtn.classList.add('uf-btn');
      addRuleBtn.onclick = () => {
          const newRule = createRule({ condition: '', Operator: '', Value: '' }, conditions);
          groupDiv.insertBefore(newRule, addRuleBtn);
      };
      groupDiv.appendChild(addRuleBtn);

      const addGroupBtn = document.createElement('button');
      addGroupBtn.innerText = 'Add group';
      addGroupBtn.classList.add('uf-btn');
      addGroupBtn.onclick = () => {
          const newGroup = createRuleGroup({ conditionOperator: 'AND', conditions: [] }, conditions);
          groupDiv.insertBefore(newGroup, addGroupBtn);
      };
      groupDiv.appendChild(addGroupBtn);

      return groupDiv;
  }

  function createRule(rule, conditions) {
      const ruleDiv = document.createElement('div');
      ruleDiv.className = 'rule';

      const conditionSelect = createSelect(conditions.filter(cond => cond !== 'Close Comparison' || cond !== 'Candle Close Comparison' || cond !== 'CloseComparison'));
      conditionSelect.value = rule.condition || '';
      ruleDiv.appendChild(conditionSelect);

      if (rule.condition === 'Candle Close Comparison' || rule.condition === 'Close Comparison' || rule.condition === 'Price Comparison' || rule.condition === 'CloseComparison') {
          const selectCondition1 = createSelect(conditions);
          selectCondition1.value = rule.Value1 || '';
          ruleDiv.appendChild(selectCondition1);

          const operatorSelect = createSelect(['<', '=', '>', '<=', '>=', '=='], true);
          operatorSelect.value = rule.Operator || '';
          ruleDiv.appendChild(operatorSelect);

          const selectCondition2 = createSelect(conditions);
          selectCondition2.value = rule.Value2 || '';
          ruleDiv.appendChild(selectCondition2);

          ruleDiv.removeChild(conditionSelect);
      } else {

          const operatorSelect = createSelect(['<', '=', '>', '<=', '>=', '=='], true);
          operatorSelect.value = rule.Operator || '';
          ruleDiv.appendChild(operatorSelect);

      if (rule.condition === 'SuperTrend' || rule.condition === 'Supertrend'|| rule.condition === 'SMA' || rule.Period) {
              const periodInput = document.createElement('input');
              periodInput.type = 'text';
              periodInput.placeholder = 'Period';
              periodInput.value = rule.Period || rule.Period1 || rule.Period2 || '';
              ruleDiv.appendChild(periodInput);

              ruleDiv.removeChild(operatorSelect);

              const operatorSelectPeriod = createSelect(['<', '=', '>', '<=', '>=', '=='], true);
              operatorSelectPeriod.value = rule.Operator || '';
              ruleDiv.appendChild(operatorSelectPeriod);
      }

      if(rule.condition === 'Candle' || rule.condition.toLowerCase() === 'candlecolor') {
              const valueInput = document.createElement('text');
              valueInput.type = 'text';
              valueInput.placeholder = 'Color';
              valueInput.value = rule.Value || '';
              ruleDiv.appendChild(valueInput);

              if(operatorSelect){
                ruleDiv.removeChild(operatorSelect);
              }
      }


<!--      if(rule.condition === 'Gann Fan Angle'){-->
<!--            ruleDiv.removeChild(operatorSelect);-->

<!--            const operatorSelectBtn = document.createElement('text');-->
<!--            operatorSelectBtn.type = 'text';-->
<!--            operatorSelectBtn.placeholder = 'Between';-->
<!--            operatorSelectBtn.value = rule.Operator || '';-->
<!--            ruleDiv.appendChild(operatorSelect);-->

<!--            const valueSelect = document.createElement('text');-->
<!--            valueSelect.type = 'text';-->
<!--            valueSelect.placeholder = 'value1'-->
<!--            valueSelect.value = rule.Value1 || '';-->
<!--            ruleDiv.appendChild(valueSelect);-->

<!--            const valuenewSelect = document.createElement('text');-->
<!--            valuenewSelect.type = 'text';-->
<!--            valuenewSelect.placeholder = 'value2';-->
<!--            valuenewSelect.value = rule.Value2 || '';-->
<!--            ruleDiv.appendChild(valuenewSelect);-->

<!--      }-->

        if(rule.condition.toLowerCase() === 'candlepattern') {
              const patternSelect = document.createElement('input');
              patternSelect.type = 'text';
              patternSelect.placeholder = 'Pattern';
              patternSelect.value = rule.Pattern || '' ;
              ruleDiv.appendChild(patternSelect);

              if (operatorSelect) {
                  ruleDiv.removeChild(operatorSelect);
              }
        }

<!--      if(rule.SubCondition){-->
<!--              const subconditionSelect = document.createElement('input');-->
<!--              subconditionSelect.type = 'input';-->
<!--              subconditionSelect.placeholder = 'subcondition';-->
<!--              subconditionSelect.value = rule.SubCondition || '';-->
<!--              ruleDiv.appendChild(subconditionSelect);-->

<!--              ruleDiv.removeChild(operatorSelect);-->
<!--      }-->

      if (rule.LongPeriod || rule.ShortPeriod) {
              const longPeriodInput = document.createElement('input');
              longPeriodInput.type = 'text';
              longPeriodInput.placeholder = 'Long Period';
              longPeriodInput.value = rule.LongPeriod || '';
              ruleDiv.appendChild(longPeriodInput);

              const shortPeriodInput = document.createElement('input');
              shortPeriodInput.type = 'text';
              shortPeriodInput.placeholder = 'Short Period';
              shortPeriodInput.value = rule.ShortPeriod || '';
              ruleDiv.appendChild(shortPeriodInput);

      } else {
              let valueInput;
              if (rule.condition === 'TimeBased' || rule.condition === 'Time Based' || rule.condition === 'Time') {
                  valueInput = document.createElement('input');
                  valueInput.type = 'text';
                  valueInput.value = rule.Value || rule.TimeFrame || '';
                  operatorSelect.style.display = 'none';
              } else if (isNaN(rule.Value)) {
                  valueInput = createSelect(conditions);
                  valueInput.value = rule.Value || '';
              } else {
                  valueInput = document.createElement('input');
                  valueInput.type = 'text';
                  valueInput.value = rule.Value || '';
              }
              ruleDiv.appendChild(valueInput);
          }
      }

      conditionSelect.onchange = () => {
          const newRule = { condition: conditionSelect.value, Operator: '', Value: '' };
          const newRuleDiv = createRule(newRule, conditions);
          ruleDiv.replaceWith(newRuleDiv);
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = 'Delete';
      deleteBtn.classList.add('uf-btn');
      deleteBtn.onclick = () => {
          ruleDiv.remove();
      };
      ruleDiv.appendChild(deleteBtn);

      return ruleDiv;
  }


  function createSelect(options, isOperator) {
      const select = document.createElement('select');
      select.classList.add('dynamic-select');
      options.forEach(option => {
          const opt = document.createElement('option');
          opt.value = option;
          opt.innerText = isOperator ? convertOperator(option) : option;
          select.appendChild(opt);
      });
      resizeSelect(select);
      select.addEventListener('change', () => resizeSelect(select));
      return select;
  }

  function resizeSelect(select) {
      const optionTexts = Array.from(select.options).map(option => option.text);
      const longestText = optionTexts.reduce((a, b) => a.length > b.length ? a : b);
      const tempSpan = document.createElement('span');
      tempSpan.style.visibility = 'hidden';
      tempSpan.style.whiteSpace = 'nowrap';
      tempSpan.innerText = longestText;
      document.body.appendChild(tempSpan);
      select.style.width = `${tempSpan.clientWidth + 10}px`;
      document.body.removeChild(tempSpan);
  }

  function convertOperator(operator) {
      switch (operator) {
          case '<': return 'less';
          case '=': return 'equal';
          case '>': return 'greater';
          case '<=': return 'less than equal';
          case '>=': return 'greater than equal';
          case '==': return 'starts';
          default: return operator;
      }
  }

  function addRuleGroup() {
      const newGroup = createRuleGroup({ conditionOperator: 'AND', conditions: [] }, conditionFields);
      ruleBuilder.appendChild(newGroup);
  }


  function parseGroup(groupDiv) {
      const conditionOperator = groupDiv.querySelector('select').value;
      const conditions = [];
      const children = groupDiv.children;

      for (let i = 1; i < children.length - 2; i++) {
          const child = children[i];
          if (child.className === 'rule') {
              const condition = child.children[0].value;
              const subCondition = child.children[1] && child.children[1].tagName === 'SELECT' ? child.children[1].value : null;
              const Operator = child.children[subCondition ? 2 : 1].value;
              const longPeriod = child.children[subCondition ? 3 : 2] && child.children[subCondition ? 3 : 2].placeholder === 'Long Period' ? child.children[subCondition ? 3 : 2].value : null;
              const shortPeriod = child.children[subCondition ? 4 : 3] && child.children[subCondition ? 4 : 3].placeholder === 'Short Period' ? child.children[subCondition ? 4 : 3].value : null;
              const value = longPeriod === null && shortPeriod === null ? child.children[subCondition ? 3 : 2].value : null;

              const conditionObj = { condition, Operator };
              if (subCondition) conditionObj.SubCondition = subCondition;
              if (longPeriod) conditionObj.LongPeriod = longPeriod;
              if (shortPeriod) conditionObj.ShortPeriod = shortPeriod;
              if (value) conditionObj.Value = value;

              conditions.push(conditionObj);
          } else if (child.className === 'rule-group') {
              conditions.push(parseGroup(child));
          }
      }

      return { conditionOperator, conditions };
  }
  function extractConditions(config) {
      const conditions = new Set();

      const extractFromConditions = (conditionList) => {
          (Array.isArray(conditionList) ? conditionList : [conditionList]).forEach(condition => {
              if (condition.condition) {
                  conditions.add(condition.condition);
              }
              if (condition.conditions) {
                  extractFromConditions(condition.conditions);
              }
              if (condition.Value) {
                  conditions.add(condition.Value);
              }
              if (condition.Value1) {
                  conditions.add(condition.Value1);
              }
              if (condition.Value2) {
                  conditions.add(condition.Value2);
              }
          });
      };

      extractFromConditions(config.BuyCondition?.conditions || config.BuyCondition || []);
      extractFromConditions(config.Buy_squareoff_condition?.conditions || config.Buy_squareoff_condition || []);
      extractFromConditions(config.SellCondition?.conditions || config.SellCondition || []);
      extractFromConditions(config.Sell_squareoff_condition?.conditions || config.Sell_squareoff_condition || []);

      return Array.from(conditions);
  }

  const conditionFields = extractConditions(initialJson.Config);

  // Helper function to check if a condition has actual data
  function hasConditionData(condition) {
    if (!condition) return false;
    // Check if it's an empty object
    if (Object.keys(condition).length === 0) return false;
    // Check if conditions array exists and has data
    if (condition.conditions && Array.isArray(condition.conditions)) {
      if (condition.conditions.length === 0) return false;
      return condition.conditions.some(c => {
        if (!c || typeof c !== 'object') return false;
        // Check if it's a nested group
        if (c.conditions) return hasConditionData(c);
        // Check if it's a valid rule with condition field
        return c.condition && typeof c.condition === 'string' && c.condition.trim() !== '';
      });
    }
    // Single condition object - check if it has a valid condition field
    if (condition.condition && typeof condition.condition === 'string' && condition.condition.trim() !== '') {
      return true;
    }
    return false;
  }

  function getRules() {
      const fullJson = {};
      
      // Only get rules from sections that exist
      const buyingGroup = ruleBuilder.querySelector('.rule-group');
      if (buyingGroup) {
          fullJson.BuyCondition = parseGroup(buyingGroup).conditions;
      }
      
      const sellGroup = SellConditionContainer.querySelector('.rule-group');
      if (sellGroup) {
          fullJson.SellCondition = parseGroup(sellGroup).conditions;
      }
      
      const buySquareoffGroup = Buy_squareoff_conditionContainer.querySelector('.rule-group');
      if (buySquareoffGroup) {
          fullJson.Buy_squareoff_condition = parseGroup(buySquareoffGroup).conditions;
      }
      
      const sellSquareoffGroup = Sell_squareoff_conditionContainer.querySelector('.rule-group');
      if (sellSquareoffGroup) {
          fullJson.Sell_squareoff_condition = parseGroup(sellSquareoffGroup).conditions;
      }

      window.alert(JSON.stringify(fullJson, null, 2));
  }

  // Only show Buying Condition if it has data
  if (hasConditionData(initialJson.Config.BuyCondition)) {
    const buyingHeader = document.createElement('h3');
    buyingHeader.innerText = 'Buying Condition';
    buyingHeader.classList.add('uf-header');
    ruleBuilder.appendChild(buyingHeader);
    ruleBuilder.appendChild(createRuleGroup(initialJson.Config.BuyCondition?.conditions ? initialJson.Config.BuyCondition : { conditionOperator: 'AND', conditions: [initialJson.Config.BuyCondition] }, conditionFields));
  } else {
    ruleBuilder.style.display = 'none';
  }

  // Only show Selling Condition if it has data
  if (hasConditionData(initialJson.Config.SellCondition)) {
    const sellHeader = document.createElement('h3');
    sellHeader.innerText = 'Selling Condition';
    sellHeader.classList.add('uf-header');
    SellConditionContainer.appendChild(sellHeader);
    SellConditionContainer.appendChild(createRuleGroup(initialJson.Config.SellCondition?.conditions ? initialJson.Config.SellCondition : { conditionOperator: 'AND', conditions: [initialJson.Config.SellCondition] }, conditionFields));
  } else {
    SellConditionContainer.style.display = 'none';
  }

  // Only show Buying Square Off Condition if it has data
  if (hasConditionData(initialJson.Config.Buy_squareoff_condition)) {
    const Buy_squareoff_conditionHeader = document.createElement('h3');
    Buy_squareoff_conditionHeader.innerText = 'Buying Square Off Condition';
    Buy_squareoff_conditionHeader.classList.add('uf-header');
    Buy_squareoff_conditionContainer.appendChild(Buy_squareoff_conditionHeader);
    Buy_squareoff_conditionContainer.appendChild(createRuleGroup(initialJson.Config.Buy_squareoff_condition?.conditions ? initialJson.Config.Buy_squareoff_condition : { conditionOperator: 'AND', conditions: [initialJson.Config.Buy_squareoff_condition] }, conditionFields));
  } else {
    Buy_squareoff_conditionContainer.style.display = 'none';
  }

  // Only show Selling Square Off Condition if it has data
  if (hasConditionData(initialJson.Config.Sell_squareoff_condition)) {
    const Sell_squareoff_conditionHeader = document.createElement('h3');
    Sell_squareoff_conditionHeader.innerText = 'Selling Square Off Condition';
    Sell_squareoff_conditionHeader.classList.add('uf-header');
    Sell_squareoff_conditionContainer.appendChild(Sell_squareoff_conditionHeader);
    Sell_squareoff_conditionContainer.appendChild(createRuleGroup(initialJson.Config.Sell_squareoff_condition?.conditions ? initialJson.Config.Sell_squareoff_condition : { conditionOperator: 'AND', conditions: [initialJson.Config.Sell_squareoff_condition] }, conditionFields));
  } else {
    Sell_squareoff_conditionContainer.style.display = 'none';
  }

</script>
  <script>
    function closeResultBox() {
      const resultBox = document.getElementById("resultBox");
      if (resultBox) {
        resultBox.style.display = "none";
        // Recenter the user form
        recenterUserForm();
      }
    }
    
    function recenterUserForm() {
      const container = document.querySelector('.container');
      const resultBox = document.getElementById("resultBox");
      
      if (container) {
        if (!resultBox || resultBox.style.display === 'none') {
          // If assistant is hidden, center the user form
          container.classList.add('centered');
        } else {
          // If assistant is visible, use two columns
          container.classList.remove('centered');
        }
      }
    }
    
    // Check on page load if assistant is visible
    document.addEventListener('DOMContentLoaded', function() {
      recenterUserForm();
    });
  </script>

  <script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>




</body>
</html>

